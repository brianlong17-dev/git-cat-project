<!DOCTYPE html>
<html>

<head>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">
    <title>Cat Petting Olympics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>

<body>
    <audio id="meow-sound" src="/static/meow.mp3"></audio>
    <h1>Pet Mr. Pussycat!</h1>
    <div id="pet">ğŸ±</div>
    <h2 id="message">Click the cat to give it love.</h2>
    <p>Love count: <span id="total-count">0</span></p>
    <div id="cat-gallery" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
    </div>
    <details id="leaderboard-details" style="margin-top: 20px; cursor: pointer;">
        <summary style="font-size: 1.2rem; font-weight: bold; color: white; list-style: none;">
            <span id="arrow">â–¶</span> Cat Rankings
        </summary>
        <div id="leaderboard-container">
            <h3>Cat Rankings</h3>
            <ul id="leaderboard-list" style="list-style: none; padding: 0;"></ul>
        </div>
    </details>



    <div id="add-cat-form-container" style="display: none;">
        <div id="add-cat-form">
            <h3>New Cat Entry</h3>
            <div class="input-row">
                <input type="text" id="new-cat-name" placeholder="Cat Name">
                <select id="new-cat-emoji" style="font-size: 20px;">
                    <option value="ğŸ±">ğŸ±</option>
                    <option value="ğŸ˜¹">ğŸ˜¹</option>
                    <option value="ğŸ˜»">ğŸ˜»</option>
                    <option value="ğŸ¦">ğŸ¦</option>
                    <option value="ğŸ¯">ğŸ¯</option>
                    <option value="ğŸ†">ğŸ†</option>
                    <option value="ğŸˆâ€â¬›">ğŸˆâ€â¬›</option>
                    <option value="ğŸ™€">ğŸ™€</option>
                </select>
                <input type="color" id="new-cat-color" value="#ffffff">
            </div>
            <button onclick="addNewCat()" style="margin-top: 15px;">Create Cat</button>
        </div>
    </div>
    <button id="toggle-form-btn" onclick="toggleCatForm()" style="margin-top: 30px;">
        + Add a New Athlete
    </button>


    <script>
        /* ============================================================
   1. GLOBAL STATE & SELECTORS
   ============================================================ */
        const pet = document.getElementById('pet');
        const counterElement = document.getElementById('total-count');
        const message = document.getElementById('message');
        const gallery = document.getElementById('cat-gallery');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardDetails = document.getElementById('leaderboard-details');
        const meowSound = document.getElementById('meow-sound');

        let currentCatId = null;
        let clickCount = 0;

        /* ============================================================
           2. API & DATA LOGIC (Functionality)
           ============================================================ */

        const loadSpecificCat = (catId) => {
            if (currentCatId != catId) {
                return fetch(`/get_cat/${catId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateCatUI(data);
                        updatePetCountUI(data.pet_count);
                        updateLeaderboard();
                    });
            }
            return Promise.resolve();
        };

        const addNewCat = () => {
            const catData = {
                name: document.getElementById('new-cat-name').value,
                emoji: document.getElementById('new-cat-emoji').value,
                color: document.getElementById('new-cat-color').value
            };

            if (!catData.name.trim()) {
                alert("Wait! Your cat needs a name.");
                return;
            }

            fetch('/add_cat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(catData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        toggleCatForm();
                        updateLeaderboard();
                        loadSpecificCat(data.id);
                    }
                });
        };

        /* ============================================================
           3. DISPLAY LOGIC (UI Updates)
           ============================================================ */

        const updateCatUI = (cat) => {
            currentCatId = cat.id;
            localStorage.setItem('lastCatId', cat.id);

            pet.innerText = cat.emoji;
            message.innerText = "The Cat's name is: " + cat.name;

            const textColor = getContrastColor(cat.bg_color);
            //document.body.style.backgroundColor = cat.bg_color;
            //document.body.style.color = textColor;
        };

        const updatePetCountUI = (count) => {
            counterElement.innerText = "â¤ï¸x" + count;
            counterElement.classList.remove('pulse-animation');
            void counterElement.offsetWidth; // Force CSS reflow
            counterElement.classList.add('pulse-animation');
        };

        const heartLogic = (count, event) => {
            const heart = document.createElement('span');
            heart.classList.add('heart');
            heart.innerText = (count % 10 === 0) ? 'ğŸ’–' : 'â¤ï¸';
            if (count % 10 === 0) heart.classList.add('gold-heart');

            const randomX = Math.floor(Math.random() * 101) - 50;
            heart.style.setProperty('--random-x', randomX + 'px');
            heart.style.left = event.pageX + 'px';
            heart.style.top = event.pageY + 'px';

            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        };

        const updateLeaderboard = () => {
            fetch('/leaderboard')
                .then(response => response.json())
                .then(data => {
                    // 1. Clear current views
                    leaderboardList.innerHTML = '';
                    gallery.innerHTML = '';

                    data.forEach((cat, index) => {
                        const rank = index + 1;

                        // 2. Build and add the Gallery Card (Top 5 only)
                        if (rank <= 5) {
                            const card = createCatCard(cat, rank);
                            gallery.appendChild(card);
                        }

                        // 3. Build and add the List Item
                        const listItem = createLeaderboardItem(cat);
                        leaderboardList.appendChild(listItem);
                    });
                });
        };

        // --- Helper: Build the Gallery Card ---
        const createCatCard = (cat, rank) => {
            const card = document.createElement('div');
            card.className = 'cat-card';
            const color = cat.bg_color;
            card.style.backgroundColor = color;
            if (getContrastColor(color) === 'black') {
                card.style.color = '#270a6c';
            } else {
                card.style.color = '#270a6c';
            }

            // Handle Medals
            if (rank === 1) card.style.boxShadow = '0 0 15px 5px gold';
            if (rank === 2) card.style.boxShadow = '0 0 15px 5px silver';
            if (rank === 3) card.style.boxShadow = '0 0 15px 5px #cd7f32';

            if (cat.id === currentCatId) card.classList.add('active-cat');

            card.innerHTML = `
        <div style="font-size: 30px;">${cat.emoji}</div>
        <div style="font-weight: bold;">${cat.name}</div>
        <div>â¤ï¸ x ${cat.pet_count}</div>
    `;

            card.onclick = () => loadSpecificCat(cat.id);
            return card;
        };

        // --- Helper: Build the List Item ---
        const createLeaderboardItem = (cat) => {
            const li = document.createElement('li');
            li.style.cursor = "pointer";
            li.style.margin = "10px 0";

            if (cat.id === currentCatId) li.classList.add('active-cat');

            li.innerHTML = `${cat.emoji} <strong>${cat.name}</strong>: ${cat.pet_count} pets`;
            li.onclick = () => loadSpecificCat(cat.id);

            return li;
        };

        // Helper: Pure Math
        function getContrastColor(hexColor) {
            hexColor = hexColor.replace("#", "");
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128 ? 'black' : 'white';
        }

        /* ============================================================
           4. EVENT LISTENERS (The Wiring)
           ============================================================ */

        pet.onclick = (event) => {
            clickCount++;
            if (clickCount % 3 === 0) {
                meowSound.currentTime = 0;
                meowSound.play();
            }

            fetch(`/pet_cat/${currentCatId}`)
                .then(response => response.json())
                .then(data => {
                    updatePetCountUI(data.pet_count);
                    heartLogic(data.pet_count, event);
                    updateLeaderboard();
                });
        };

        leaderboardDetails.addEventListener('toggle', (event) => {
            localStorage.setItem('rankingsOpen', event.target.open);
        });

        const toggleCatForm = () => {
            const container = document.getElementById('add-cat-form-container');
            const btn = document.getElementById('toggle-form-btn');
            const isOpen = container.style.display === 'none';

            container.style.display = isOpen ? 'block' : 'none';
            btn.innerText = isOpen ? 'Cancel' : '+ Add a New Athlete';
            btn.style.background = isOpen ? '#e74c3c' : '#00ce8a';
        };

        /* ============================================================
           5. INITIALIZATION
           ============================================================ */

        window.onload = () => {
            const savedId = localStorage.getItem('lastCatId');
            const rankingsWasOpen = localStorage.getItem('rankingsOpen') === 'true';

            if (rankingsWasOpen) leaderboardDetails.open = true;

            if (savedId) {
                loadSpecificCat(savedId).then(() => {
                    document.body.style.opacity = 1;
                });
            } else {
                fetch('/initial_pet')
                    .then(response => response.json())
                    .then(data => {
                        updateCatUI(data);
                        updatePetCountUI(data.pet_count);
                        updateLeaderboard();
                        document.body.style.opacity = 1;
                    });
            }
        };



    </script>
</body>

</html>